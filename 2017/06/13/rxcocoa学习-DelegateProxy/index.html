<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>rxcocoa学习-DelegateProxy | lyyourc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
  
</head>

<body>
  <nav class="app-nav">
  
    
      <a href="/.">home</a>
    
  
    
      <a href="/archives">archive</a>
    
  
    
      <a href="/atom.xml">rss</a>
    
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2017/06/13/rxcocoa学习-DelegateProxy/">rxcocoa学习-DelegateProxy</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">June 13 2017</p>
  </section>

  <section class="article-entry">
    <p>DelegateProxy是对 ios中delegate的封装，能够将delegate的方法调用转换为一个observable sequence。先来看几张图。</p>
<p><img src="http://xingou.oss-cn-shanghai.aliyuncs.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-06-13%20%E4%B8%8A%E5%8D%8811.24.45.png" alt=""></p>
<p>从文档上的这个图可以看出：我们的DelegateProxy充当的是一个中间转换角色。uiscrollview的delegate设置为delegateProxy。然后有两种情况：</p>
<ul>
<li>delegateProxy实现了delegate的方法，那么直接在对应方法里on event</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// delegate proxy part (RxScrollViewDelegateProxy)</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> internalSubject = <span class="type">PublishSubject</span>&lt;<span class="type">CGPoint</span>&gt;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">requiredDelegateMethod</span><span class="params">(scrollView: UIScrollView, arg1: CGPoint)</span></span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    internalSubject.on(.next(arg1))</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>._forwardToDelegate?.requiredDelegateMethod?(scrollView, arg1: arg1) ?? defaultReturnValue</div><div class="line">&#125;</div><div class="line"></div><div class="line">....</div><div class="line"></div><div class="line"><span class="comment">// reactive property implementation in a real class (`UIScrollView`)</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> property: <span class="type">Observable</span>&lt;<span class="type">CGPoint</span>&gt; &#123;</div><div class="line">    <span class="keyword">let</span> proxy = <span class="type">RxScrollViewDelegateProxy</span>.proxyForObject(base)</div><div class="line">    <span class="keyword">return</span> proxy.internalSubject.asObservable()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果delegateProxy没有实现对应的方法，那么就会触发NSObject的forwardInvocation来将message转发。所以在_RxDelegateProxy中重载了这个方法。</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">-(void)forwardInvocation:(<span class="type">NSInvocation</span> *)anInvocation &#123;</div><div class="line">    <span class="type">BOOL</span> isVoid = <span class="type">RX_is_method_signature_void</span>(anInvocation.methodSignature);</div><div class="line">    <span class="type">NSArray</span> *arguments = <span class="literal">nil</span>;</div><div class="line">    <span class="comment">//让其他对象响应前，先调用_sentMessage</span></div><div class="line">    <span class="keyword">if</span> (isVoid) &#123;</div><div class="line">        arguments = <span class="type">RX_extract_arguments</span>(anInvocation);</div><div class="line">        [<span class="keyword">self</span> _sentMessage:anInvocation.selector withArguments:arguments];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">///让_forwardToDelegate去响应</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>._forwardToDelegate &amp;&amp; [<span class="keyword">self</span>._forwardToDelegate respondsToSelector:anInvocation.selector]) &#123;</div><div class="line">        [anInvocation invokeWithTarget:<span class="keyword">self</span>._forwardToDelegate];</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//让其他对象响应后，调用_methodInvoked</span></div><div class="line">    <span class="keyword">if</span> (isVoid) &#123;</div><div class="line">        [<span class="keyword">self</span> _methodInvoked:anInvocation.selector withArguments:arguments];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>_sentMessage和_methodInvoked方法都是从一个[Selector:PublishSubject]的字典中查找对应的subject，找到后调用on方法。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">_sentMessage</span><span class="params">(<span class="number">_</span> selector: Selector, withArguments arguments: [Any])</span></span> &#123;</div><div class="line">        sentMessageForSelector[selector]?.on(.next(arguments))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">_methodInvoked</span><span class="params">(<span class="number">_</span> selector: Selector, withArguments arguments: [Any])</span></span> &#123;</div><div class="line">        methodInvokedForSelector[selector]?.on(.next(arguments))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那selector又是什么时候加入到了sentMessageForSelector中的呢？</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//注意只能是返回为void的selector</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">methodInvoked</span><span class="params">(<span class="number">_</span> selector: Selector)</span></span> -&gt; <span class="type">Observable</span>&lt;[<span class="type">Any</span>]&gt; &#123;</div><div class="line">        <span class="type">MainScheduler</span>.ensureExecutingOnScheduler()</div><div class="line">        checkSelectorIsObservable(selector)</div><div class="line"></div><div class="line">        <span class="keyword">let</span> subject = methodInvokedForSelector[selector]</div><div class="line"></div><div class="line">        <span class="keyword">if</span> <span class="keyword">let</span> subject = subject &#123;</div><div class="line">            <span class="keyword">return</span> subject.asObservable()</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">// 不存在，添加，构建一个subject的wrapperMessageDispatcher 添加到字典中</span></div><div class="line">            <span class="keyword">let</span> subject =  <span class="type">MessageDispatcher</span>(delegateProxy: <span class="keyword">self</span>)</div><div class="line">            methodInvokedForSelector[selector] = subject</div><div class="line">            <span class="keyword">return</span> subject.asObservable()</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">///另一个函数类似</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sentMessage</span><span class="params">(<span class="number">_</span> selector: Selector)</span></span> -&gt; <span class="type">Observable</span>&lt;[<span class="type">Any</span>]&gt;</div></pre></td></tr></table></figure>
<p>了解了个大概，还是从具体的例子开始：</p>
<p><img src="http://xingou.oss-cn-shanghai.aliyuncs.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202017-06-13%20%E4%B8%8B%E5%8D%882.41.01.png" alt=""></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">///didEndDecelerating delegate方法时会调用Observer的方法</span></div><div class="line">scrollView</div><div class="line">.rx</div><div class="line">.didEndDecelerating</div><div class="line">.subscribe &#123; (event) <span class="keyword">in</span></div><div class="line">    <span class="built_in">print</span>(<span class="string">"didEndDecelerating"</span>)</div><div class="line">&#125;.disposed(by: bag)</div></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//再来看看didEndDecelerating的实现</span></div><div class="line"><span class="comment">/**</span></div><div class="line">先创建一个RxScrollViewDelegateProxy，注意proxyForObject方法中做了很多事情。</div><div class="line">之后可以看到RxScrollViewDelegateProxy虽然遵循了UIScrollViewDelegate协议，但是并未实现里面的方法(只有一个didscroll)。这样按照上面的说明，就要进入forwardInvocation的流程，所以，我们得调用sendMessage或者methodInvoked来对selector和subject进行绑定。</div><div class="line"></div><div class="line">最后将其封装为ControlEvent返回。(为了ControlEvent的特性：保证主线程上执行)</div><div class="line">*/</div><div class="line"><span class="keyword">var</span> didEndDecelerating: <span class="type">ControlEvent</span>&lt;<span class="type">Void</span>&gt; &#123;</div><div class="line">    <span class="keyword">let</span> source = delegate.methodInvoked(#selector(<span class="type">UIScrollViewDelegate</span>.scrollViewDidEndDecelerating(<span class="number">_</span>:))).<span class="built_in">map</span> &#123; <span class="number">_</span> <span class="keyword">in</span> &#125;</div><div class="line">    <span class="keyword">return</span> <span class="type">ControlEvent</span>(events: source)</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="keyword">var</span> delegate: <span class="type">DelegateProxy</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="type">RxScrollViewDelegateProxy</span>.proxyForObject(base)</div><div class="line">&#125;</div><div class="line"><span class="comment">//-------------------------</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">proxyForObject</span><span class="params">(<span class="number">_</span> object: AnyObject)</span></span> -&gt; <span class="type">Self</span> &#123;</div><div class="line">    <span class="type">MainScheduler</span>.ensureExecutingOnScheduler()</div><div class="line"></div><div class="line">    <span class="keyword">let</span> maybeProxy = <span class="type">Self</span>.assignedProxyFor(object) <span class="keyword">as</span>? <span class="type">Self</span></div><div class="line"></div><div class="line">    <span class="keyword">let</span> proxy: <span class="type">Self</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> existingProxy = maybeProxy &#123;</div><div class="line">        proxy = existingProxy</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">///创建delegateProxy对象</span></div><div class="line">        proxy = <span class="type">Self</span>.createProxyForObject(object) <span class="keyword">as</span>! <span class="type">Self</span></div><div class="line">        <span class="comment">//关联delegateProxy和Scrollview</span></div><div class="line">        <span class="type">Self</span>.assignProxy(proxy, toObject: object)</div><div class="line">        <span class="built_in">assert</span>(<span class="type">Self</span>.assignedProxyFor(object) === proxy)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> currentDelegate: <span class="type">AnyObject</span>? = <span class="type">Self</span>.currentDelegateFor(object)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> currentDelegate !== proxy &#123;</div><div class="line">       <span class="comment">//设置forwardDelegate</span></div><div class="line">        proxy.setForwardToDelegate(currentDelegate, retainDelegate: <span class="literal">false</span>)</div><div class="line">        <span class="built_in">assert</span>(proxy.forwardToDelegate() === currentDelegate)</div><div class="line">        <span class="comment">//将scrollview的delegate设置为delegateProxy</span></div><div class="line">        <span class="type">Self</span>.setCurrentDelegate(proxy, toObject: object)</div><div class="line">        <span class="built_in">assert</span>(<span class="type">Self</span>.currentDelegateFor(object) === proxy)</div><div class="line">        <span class="built_in">assert</span>(proxy.forwardToDelegate() === currentDelegate)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> proxy</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到在实现didEndDecelerating时，拿到subject后执行了map操作，这样我们subscribe时的event里面就什么信息也没有，如果我们想event里包含参数信息，那么我们可以去掉map操作。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//自己实现对scrollViewDidEndDecelerating的封装。</span></div><div class="line">scrollView</div><div class="line">.rx</div><div class="line">.delegate</div><div class="line">.sentMessage(#selector(<span class="type">UIScrollViewDelegate</span>.scrollViewDidEndDecelerating(<span class="number">_</span>:)))</div><div class="line">.subscribeOn(<span class="type">ConcurrentMainScheduler</span>.instance)</div><div class="line">.subscribe &#123; (event) <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> scrollView = event.element?[<span class="number">0</span>] <span class="keyword">as</span>? <span class="type">UIScrollView</span> &#123;</div><div class="line">        <span class="built_in">print</span>(scrollView.contentOffset)</div><div class="line">    &#125;</div><div class="line">&#125;.disposed(by: bag)</div></pre></td></tr></table></figure>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="http://7xrcp8.com1.z0.glb.clouddn.com/avatar.png" alt="avatar" />
    <div class="grid-item">
      <p class="title"> lyyourc </p>
      <p class="subtitle"> You Are The JavaScript In My HTML </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="DrakeLeung"
  href="https://twitter.com/intent/tweet?text=DelegateProxy是对 ios中"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'drakeleung';
  
  var disqus_url = 'http://yoursite.com/2017/06/13/rxcocoa学习-DelegateProxy/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>

</body>
</html>
